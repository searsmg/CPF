---
title: "Bennett rainfall and streamflow response"
author: "Megan Sears"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: journal
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F,
                      message = F,
                      fig.width = 12,
                      fig.height = 6)

library(tidyverse)
library(stringr)
library(lubridate)
library(plotly)
library(kableExtra)
library(here)
library(ggplot2); theme_set(theme_bw(base_size = 16))
library(viridis)
library(gridExtra)

```


```{r loading data, include=FALSE}
setwd("N:/Research/Kampf/Private/field_data/bennett")

#load rainfall metric functions
load('rain_metrics.RData')

#pull in all filenames with composite
filenames <- list.files(".", pattern="composite", full.names=F)

#read all the csvs
dataframes <- lapply(filenames, read.csv)

#name all the csv
names(dataframes) <- substr(filenames, 1, 14)

#extract csvs from list to global env
lapply(names(dataframes), function(x) assign(x, dataframes[[x]], envir = .GlobalEnv))
rm(dataframes) #remove dataframes list

```

# Daily rainfall (via tipping buckets)

```{r initial processing, echo=FALSE}
#me rain
me_rain <- me_rain_compos %>%
  mutate(site = "me") %>%
  rename(datetime = 1) %>%
  mutate(datetime = parse_date_time(datetime, 
                                  orders = c('%m/%d/%Y %H:%M',
                                             '%m/%d/%y %I:%M:%S %p',
                                             '%m-%d-%y %H:%M',
                                             '%Y-%m-%d %H:%M')),
         precip_mm = 0.254) %>%
  filter(!between(datetime, as.POSIXct('2021-10-31 00:00:00', tz='MST'),
                                as.POSIXct('2022-05-05 00:00:00', tz='MST')))

rm(me_rain_compos)

#mm rain
mm_rain <- mm_rain_compos %>%
  mutate(site = "mm") %>%
  mutate(datetime = ymd_hm(datetime),
         precip_mm = 0.254) %>%
  filter(!between(datetime, as.POSIXct('2021-10-31 00:00:00', tz='MST'),
                                as.POSIXct('2022-05-05 00:00:00', tz='MST')))

rm(mm_rain_compos)
  
#mw rain
mw_rain <- mw_rain_compos %>%
  mutate(site = "mw") %>%
  mutate(datetime = parse_date_time(datetime, 
                                    orders = c('%m/%d/%Y %H:%M',
                                               '%Y-%m-%d %H:%M')),
         precip_mm = 0.254) %>%
  filter(!between(datetime, as.POSIXct('2021-10-31 00:00:00', tz='MST'),
                                as.POSIXct('2022-05-05 00:00:00', tz='MST')))
rm(mw_rain_compos)

#ue rain
ue_rain <- ue_rain_compos %>%
  mutate(site = "ue") %>%
  mutate(datetime = parse_date_time(datetime, 
                                    orders = c('%m/%d/%Y %H:%M',
                                               '%m/%d/%y %I:%M:%S %p',
                                               '%Y-%m-%d %H:%M')),
         precip_mm = 0.254) %>%
  filter(!between(datetime, as.POSIXct('2021-10-31 00:00:00', tz='MST'),
                                as.POSIXct('2022-05-05 00:00:00', tz='MST')))

rm(ue_rain_compos)

#um rain
um_rain <- um_rain_compos %>%
  mutate(site = "um") %>%
  mutate(datetime = mdy_hm(datetime),
         precip_mm = 0.254) %>%
  filter(!between(datetime, as.POSIXct('2021-10-31 00:00:00', tz='MST'),
                                as.POSIXct('2022-05-05 00:00:00', tz='MST')))

rm(um_rain_compos)

#uw rain
uw_rain <- uw_rain_compos %>%
  mutate(site = "uw") %>%
  mutate(datetime = parse_date_time(datetime, 
                                    orders = c('%m/%d/%Y %H:%M',
                                               '%Y-%m-%d %H:%M')),
         precip_mm = 0.254) %>%
  filter(!between(datetime, as.POSIXct('2021-10-31 00:00:00', tz='MST'),
                                as.POSIXct('2022-05-05 00:00:00', tz='MST')))
  
rm(uw_rain_compos)
  
#bind all rain data together
rain <- bind_rows(me_rain, mm_rain, mw_rain, ue_rain, um_rain, uw_rain)

rain_daily <- rain %>%
  mutate(date = date(datetime)) %>%
  group_by(site, date) %>%
  summarize(dailyp_mm = sum(precip_mm))

#daily rain plot
rain_daily_plot <- rain_daily %>%
  ungroup() %>% 
  mutate(year = year(date),
         treatment = if_else(site %in% c('mm', 'me', 'mw'),
                             'mulch',
                             'no mulch')) %>%
  ggplot(aes(x=date, y=dailyp_mm, 
             color=site, 
             shape = treatment)) +
  geom_point(size =3) + 
  ylim(0,50) +
  ggtitle('Daily rainfall') +
  scale_color_brewer(palette = "Dark2") +
  facet_wrap(~year, scales = 'free_x')

ggplotly(rain_daily_plot)

## need to write to csv so can be used to determine rainfall metrics
#write.csv(rain, 'bennett_all_rain.csv')
#write.csv(rain_daily, 'rain_daily.csv')

```

# Event-based rainfall metrics

Derived from tipping bucket data

```{r rainfall metrics, echo=FALSE}

#me 
# me_rain <- get_setup(me_rain, me_rain$datetime)
# me_events <- get_events(me_rain, me_rain$P_mm, me_rain$datenumeric,
#                         me_rain$end, me$rain_start)
# me_events <- get_intensities(me_events, me_events$event, me_rain)

#write_csv(me_events, 'me_rain_events.csv')
me_events <- read_csv('me_rain_events.csv')

#mm
#use gap fill mm_rain (gap filled with me)
# mm_rain <- read_csv("mm_rain_gapfill.csv") %>%
#   mutate(datetime = ymd_hm(datetime))
# 
# mm_rain <- get_setup(mm_rain, mm_rain$datetime)
# mm_events <- get_events(mm_rain, mm_rain$P_mm, mm_rain$datenumeric,
#                        mm_rain$end, mm$rain_start)
# 
# mm_events <- get_intensities(mm_events, mm_events$event, mm_rain)

#write_csv(mm_events, 'mm_rain_events.csv')
mm_events <- read_csv('mm_rain_events.csv')

#mw
# mw_rain <- get_setup(mw_rain, mw_rain$datetime)
# mw_events <- get_events(mw_rain, mw_rain$P_mm, mw_rain$datenumeric,
#                         mw_rain$end, mw$rain_start)
# mw_events <- get_intensities(mw_events, mw_events$event, mw_rain)

#write_csv(mw_events, 'mw_rain_events.csv')
mw_events <- read_csv('mw_rain_events.csv')

#ue
# ue_rain <- get_setup(ue_rain, ue_rain$datetime)
# ue_events <- get_events(ue_rain, ue_rain$P_mm, ue_rain$datenumeric,
#                         ue_rain$end, ue$rain_start)
# ue_events <- get_intensities(ue_events, ue_events$event, ue_rain)

#write_csv(ue_events, 'ue_rain_events.csv')
ue_events <- read_csv('ue_rain_events.csv')

#um -- **use uw since there is no um data**
# um_rain <- get_setup(um_rain, um_rain$datetime)
# um_events <- get_events(um_rain, um_rain$P_mm, um_rain$datenumeric,
#                        um_rain$end, um$rain_start)
# um_events <- get_intensities(um_events, um_events$event, um_rain)

#write_csv(um_events, 'um_rain_events.csv')
um_events <- read_csv('um_rain_events.csv')

#uw
# uw_rain <- get_setup(uw_rain, uw_rain$datetime)
# uw_events <- get_events(uw_rain, uw_rain$P_mm, uw_rain$datenumeric,
#                         uw_rain$end, uw$rain_start)
# uw_events <- get_intensities(uw_events, uw_events$event, uw_rain)

# write_csv(uw_events, 'uw_rain_events.csv')
uw_events <- read_csv('uw_rain_events.csv')

#add site id to each events df 
me_events <- me_events %>% 
  mutate(Site = 'me')

mm_events <- mm_events %>% 
  mutate(Site = 'mm')

mw_events <- mw_events %>% 
  mutate(Site = 'mw')

ue_events <- ue_events %>% 
  mutate(Site = 'ue')

um_events <- um_events %>% 
  mutate(Site = 'um')

uw_events <- uw_events %>% 
  mutate(Site = 'uw')

#bind event dfs together
event_list <- list(me_events, mm_events, mw_events,
                   ue_events, um_events, uw_events)

#all events for all sites
events <- bind_rows(event_list)

p <- ggplot(events, aes(x=Site, y=P)) + 
  geom_boxplot() +
  ggtitle('Precip per event (mm)')

dur <- ggplot(events, aes(x=Site, y=duration_hr)) + 
  geom_boxplot() +
  ggtitle('Event duration (hr)')

mi60 <- ggplot(events, aes(x=Site, y=MI60)) + 
  geom_boxplot() +
  ggtitle('MI60 (mm/hr)')

mi30 <- ggplot(events, aes(x=Site, y=MI30)) + 
  geom_boxplot() +
  ggtitle('MI30 (mm/hr)')

mi15 <- ggplot(events, aes(x=Site, y=MI15)) + 
  geom_boxplot() +
  ggtitle('MI15 (mm/hr)')

mi5 <- ggplot(events, aes(x=Site, y=MI5)) + 
  geom_boxplot()+
  ggtitle('MI5 (mm/hr)')

grid.arrange(p, dur, mi60, mi30, mi15, mi5, nrow=3)

events_summary <- events %>%
  select(c(Site, P, MI60, MI30, MI15, MI5)) %>%
  group_by(Site) %>%
  summarize(Count = n(),
            Total_P = sum(P, na.rm = TRUE),
            Max_P = max(P, na.rm = TRUE),
            Max_MI60 = max(MI60, na.rm = TRUE),
            Max_MI30 = max(MI30, na.rm = TRUE),
            Max_MI15 = max(MI15, na.rm = TRUE),
            Max_MI5 = max(MI5, na.rm = TRUE)) %>%
  mutate_if(is.numeric,
            round,
            digits = 4)

kable(events_summary) %>%
  kable_styling()

```

# Stream stage

```{r process stage data, echo=FALSE}

#me stage
me_stage <- me_stage_compo %>%
  mutate(site = 'me',
         datetime = parse_date_time(datetime, 
                                    orders = c('%m/%d/%Y %H:%M',
                                               '%m-%d-%Y %H:%M:%S')))
rm(me_stage_compo)

#me_upper stage
me_upper_stage <- me_upper_stage %>%
  mutate(site = 'me_upper',
         datetime = mdy_hms(datetime))

#mm stage
mm_stage <- mm_stage_compo %>%
  mutate(site = 'mm',
         datetime = parse_date_time(datetime, 
                                    orders = c('%m/%d/%Y %H:%M',
                                               '%m/%d/%Y %H:%M:%S')))
rm(mm_stage_compo)

#mm upper stage
mm_upper_stage <- mm_upper_stage %>%
  mutate(site = 'mm_upper',
         datetime = mdy_hms(datetime))

#mw stage
mw_stage <- mw_stage_compo %>%
  mutate(site = 'mw',
         datetime = parse_date_time(datetime, 
                                    orders = c('%m/%d/%Y %H:%M',
                                               '%m/%d/%Y %H:%M:%S')))
rm(mw_stage_compo)

#mw_upper stage
mw_upper_stage <- mw_upper_stage %>%
  mutate(site = 'mw_upper',
         datetime = mdy_hms(datetime))

#ue stage
ue_stage <- ue_stage_compo %>%
  mutate(site = 'ue',
         datetime = parse_date_time(datetime, 
                                    orders = c('%m/%d/%Y %H:%M',
                                               '%m/%d/%Y %H:%M:%S')))
rm(ue_stage_compo)

#ue_upper stage (not downloaded yet)
ue_upper_stage <- ue_upper_stage %>%
  mutate(site = 'ue_upper',
         datetime = mdy_hms(datetime))

#um stage
um_stage <- um_stage_compo %>%
  mutate(site = 'um',
         datetime = parse_date_time(datetime, 
                                    orders = c('%m/%d/%Y %H:%M',
                                               '%m/%d/%Y %H:%M:%S')))

rm(um_stage_compo)

#um_lower stage
um_lower_stage <- um_lower_stage %>%
  mutate(site = 'um_lower',
         datetime = parse_date_time(datetime, 
                                    orders = c('%m/%d/%Y %H:%M',
                                               '%m/%d/%Y %H:%M:%S')))
#uw stage
uw_stage <- uw_stage_compo %>%
  mutate(site = 'uw',
         datetime = parse_date_time(datetime, 
                                    orders = c('%m/%d/%Y %H:%M',
                                               '%m-%d-%Y %H:%M:%S')))

rm(uw_stage_compo)

#uw_upper stage
uw_upper_stage <- uw_upper_stage %>%
  mutate(site = 'uw_upper',
         datetime = mdy_hms(datetime))

stage <- bind_rows(me_stage, me_upper_stage, mm_stage, mm_upper_stage,
                   mw_stage, mw_upper_stage, ue_stage, ue_upper_stage, um_stage, um_lower_stage,
                   uw_stage, uw_upper_stage)

stage_plot <- ggplot(stage, aes(x=datetime, y=Stage_mm/10)) +
  geom_line() +
  labs(y = 'Stage (cm)',
       x = 'Date') +
  scale_x_datetime(date_labels = "%b-%y", date_break = "3 months") +
  theme(axis.text.x = element_text(angle = 45)) +
  facet_wrap(~site)

#stage_plot
  
#ggplotly(stage_plot)

#write.csv(stage, 'bennett_stage.csv')

# save(me_stage, mm_stage,
#      mw_stage, ue_stage,
#      um_stage, uw_stage,
#      file = 'stage.Rdata')

```

# Stage response to rainfall (tipping buckets)

```{r stage response, echo = FALSE}

#get stage response for each site
me_response <- get_stageresponse(me_events, me_stage)
mm_response <- get_stageresponse(mm_events, mm_stage)
mw_response <- get_stageresponse(mw_events, mw_stage)
ue_response <- get_stageresponse(ue_events, ue_stage)
um_response <- get_stageresponse(uw_events, um_stage) #use uw_events
uw_response <- get_stageresponse(uw_events, uw_stage)

response_list <- list(me_response, mm_response, mw_response,
                   ue_response, um_response, uw_response)

#all events for all sites
response <- bind_rows(response_list)

ggplot(response, aes(x=site, y=Stage_range/10)) + 
  geom_boxplot() +
  labs(y = 'Stage Response (cm)') +
  ggtitle('Stage response amount')

ggplot(response, aes(x=site, y=lag2p_hr)) + 
  geom_boxplot() +
  ggtitle('Lag to Peak (hr)')

ggplot(response, aes(x=site, y=Stage_mm_max/10)) + 
  geom_boxplot() +
  labs(y = "Max stage (cm)") +
  ggtitle('Max stage')

response %>% 
  mutate(treatment = if_else(site %in% c('mm', 'me', 'mw'),
                             'mulch',
                             'no mulch')) %>%
  ggplot(aes(x=MI60, y=Stage_range/10, color = site, shape = treatment)) + 
  geom_point(size =2) +
  labs(y = 'Max stage (cm)') +
  scale_color_brewer(palette = "Dark2") +
  ggtitle('MI60 vs stage max')

response_summary <- response %>%
  ungroup() %>% 
  select(c(site, Stage_mm_max, Stage_range, lag2p_hr, response)) %>%
  group_by(site) %>%
  summarize(Count = n(),
            Positive_response = sum(response),
            Max_Stage_Response = max(Stage_range),
            Mean_Stage_response = mean(Stage_range),
            Mean_lag2p_hr = mean(lag2p_hr)) %>%
  mutate_if(is.numeric,
            round,
            digits = 2)

ggplot(response_summary, aes(x=site, y=(Positive_response/Count))) + 
  geom_col() +
  ggtitle('Percent of response (response to events/total events)')

kable(response_summary) %>%
  kable_styling()

```

# Rainfall thresholds

```{r rainfall thresholds, echo = FALSE}

me_thresh <- get_thresholds(me_response) %>%
  mutate(site = 'me')
mm_thresh <- get_thresholds(mm_response) %>%
  mutate(site = 'mm')
mw_thresh <- get_thresholds(mw_response) %>%
  mutate(site = 'mw')
ue_thresh <- get_thresholds(ue_response) %>%
  mutate(site = 'ue')
um_thresh <- get_thresholds(um_response) %>%
  mutate(site = 'um')
uw_thresh <- get_thresholds(uw_response) %>%
  mutate(site = 'uw')


thresh_list <- list(me_thresh, mm_thresh, mw_thresh,
                   ue_thresh, um_thresh, uw_thresh)

#all events for all sites
thresh <- bind_rows(thresh_list)

kable(thresh) %>%
  kable_styling()

```

# Larimer County Bennett rain and Q

## Larimer Country Bennett rainfall metrics

```{r larimer co rainfall metrics, echo = FALSE}
#hourly data
ben_rain <- read_csv(here('./bennett/larimerco_bennett_precip.csv')) %>%
  mutate(datetime = ymd_hm(DateTime)) %>%
  mutate(precip_mm = precip_in*25.4) %>%
  filter(datetime > '2021-06-21 00:00') %>%
  filter(!between(datetime, as.POSIXct('2021-10-31 00:00', tz='MST'),
                                as.POSIXct('2022-05-05 00:00', tz='MST'))) %>%
  select(datetime, precip_mm) %>%
  filter(precip_mm > 0)


#### need to setup differently since it's not recorded for each tip ####
get_setup2 <- function(df, datetime, precip_mm) {
  
  df$datetime = as.POSIXct(df$datetime,tz="MST", format="%m/%d/%Y %H:%M")
  df$datenumeric=as.numeric(df$datetime)

  #calculate time between tips
  for (i in 2:nrow(df)) {
    df[i,'dt']=df[i,'datenumeric']-df[i-1,'datenumeric']
  }
  df$dt_hr=as.numeric(df$dt)/60/60
  
  #start new event if time between tips >=6
  df$event=1
  for (i in 2:nrow(df)) {
    df[i,'event']=ifelse(df[i,'dt_hr']<6,df[i-1,'event'],df[i-1,'event']+1)
  }
  #df$P_in = 0.01
  df$P_mm = df$precip_mm
  
  return(df)
}
####

ben_rain <- get_setup2(ben_rain, ben_rain$datetime)

ben_events <- get_events(ben_rain, ben_rain$precip_mm, ben_rain$datenumeric,
                        ben_rain$end, ben_rain$rain_start)


ben_events <- get_intensities(ben_events, ben_events$event, ben_rain)

ben_events <- ben_events %>%
  mutate(Site = 'ben')

## look at data

ggplot(ben_events, aes(x=Site, y=P)) + geom_boxplot() +
  ggtitle('Precip per event (mm)')

ggplot(ben_events, aes(x=Site, y=duration_hr)) + geom_boxplot() +
  ggtitle('Event duration (hr)')

ggplot(ben_events, aes(x=Site, y=MI60)) + geom_boxplot() +
  ggtitle('MI60')

# summary

ben_events_summary <- ben_events %>%
  select(c(Site, P, MI60)) %>%
  summarize(Count = n(),
            Total_P = sum(P, na.rm = TRUE),
            Max_P = max(P, na.rm = TRUE),
            Max_MI60 = max(MI60, na.rm = TRUE)) %>%
  mutate_if(is.numeric,
            round,
            digits = 4)

kable(ben_events_summary) %>%
  kable_styling()

```

## Larimer County Bennett stage/Q metrics

```{r Larimer co stage, echo = F}

ben_q <- read_csv(here('./bennett/larimerco_bennett_Q.csv')) %>%
  rename(datetime = DateTime) %>%
  mutate(datetime = ymd_hm(datetime)) %>% 
  mutate(q_cms = q_cfs*0.028)

#### get Q response instead of stage ####
get_Qresponse <- function(events_df, q_df) {
  
  response <- data.frame()
  
  for(i in 1:nrow(events_df)){
    temp <- q_df %>%
      filter(datetime >=(events_df$starttime[i]) 
             & datetime <=(events_df$endtime[i] + 12*60*60))
    
    temp$event = ifelse(temp$datetime >=(events_df$starttime[i]) 
                        & temp$datetime <=(events_df$endtime[i] + 12*60*60),
                        events_df$event[i])
    
    temp$duration_hr = ifelse(temp$datetime >=(events_df$starttime[i]) 
                              & temp$datetime <=(events_df$endtime[i] + 12*60*60),
                              events_df$duration_hr[i])
    
    temp$P = ifelse(temp$datetime >=(events_df$starttime[i]) 
                    & temp$datetime <=(events_df$endtime[i] + 12*60*60),
                    events_df$P[i])
    
    temp$MI60 = ifelse(temp$datetime >=(events_df$starttime[i]) 
                       & temp$datetime <=(events_df$endtime[i] + 12*60*60),
                       events_df$MI60[i])
    
    temp$starttime = ifelse(temp$datetime >=(events_df$starttime[i]) 
                            & temp$datetime <=(events_df$endtime[i] + 12*60*60),
                            events_df$starttime[i])
    
    temp$endtime = ifelse(temp$datetime >=(events_df$starttime[i]) 
                          & temp$datetime <=(events_df$endtime[i] + 12*60*60),
                          events_df$endtime[i])
    
    response <- rbind(response, temp)
  }
  
  out <- response %>%
    group_by(event) %>%
    mutate(q_range = max(q_cms) - min(q_cms)) %>%
    group_by(event) %>%
    filter(q_cms == max(q_cms)) %>%
    rename(q_cms_max = q_cms) %>% 
    group_by(event) %>%
    filter(datetime == max(datetime)) %>%
    rename(datetime_maxq = datetime) %>%
    mutate(starttime_rain = as_datetime(starttime),
           endtime_rain = as_datetime(endtime),
           lag2p_hr = as.numeric(datetime_maxq - starttime_rain)) %>%
    #filter(!duration_hr == 0) %>% #take this out bc it's not based on tips
    mutate(response = ifelse(q_range > 0, 1, 0)) %>% 
    select(-c(starttime, endtime))
  
}


ben_response <- get_Qresponse(ben_events, ben_q)

ben_response <- ben_response %>% mutate(site = 'ben')

# look at data
ggplot(ben_response, aes(x=site, y=q_range)) + geom_boxplot() +
  ggtitle('Q response amount (cms)')

ggplot(ben_response, aes(x=site, y=lag2p_hr)) + geom_boxplot() +
  ggtitle('Lag to Peak (hr)')

ggplot(ben_response, aes(x=site, y=q_cms_max)) + geom_boxplot() +
  ggtitle('Q max (cms)')


#response summary
ben_response_summary <- ben_response %>%
  select(c(site, q_cms_max, q_range, lag2p_hr, response)) %>%
  group_by(site) %>% 
  summarize(Count = n(),
            Positive_response = sum(response),
            Max_q_Response = max(q_range),
            Mean_q_response = mean(q_range),
            Mean_lag2p_hr = mean(lag2p_hr),
            Max_lag2p_hr = max(lag2p_hr)) %>%
  mutate_if(is.numeric,
            round,
            digits = 2)

kable(ben_response_summary) %>%
  kable_styling()


# all 81 events have responses? so not calculating threshold & kappa

```

# Logistic regression 

Rainfall (tipping buckets) thresholds using a logistic regression

```{r}
library(irr)

ben_q <- ben_q %>%
  rename(floor_dt = datetime)

#########################################
#mm
mm_response2 <- mm_response %>%
  mutate(floor_dt = floor_date(datetime_maxstage, 'hour'))
    
mm_response2 <- left_join(mm_response2, ben_q, by = 'floor_dt') %>%
  mutate(doy = yday(floor_dt))

mm_glm <- glm(response ~ q_cms + doy, data = mm_response2, family = binomial)

mm_response2$pred <- predict(mm_glm, mm_response2, type = 'response')

mm_response3 <- mm_response2 %>%
  mutate(prediction = if_else(pred > 0.5, 1, 0)) %>%
  ungroup() %>% 
  select(response, prediction)

mm_kappa <- kappa2(mm_response3)
mm_kappa$value

######################################
#me
me_response2 <- me_response %>%
  mutate(floor_dt = floor_date(datetime_maxstage, 'hour'))
    
me_response2 <- left_join(me_response2, ben_q, by = 'floor_dt') %>%
  mutate(doy = yday(floor_dt))

me_glm <- glm(response ~ q_cms + doy, data = me_response2, family = binomial)

me_response2$pred <- predict(me_glm, me_response2, type = 'response')

me_response3 <- me_response2 %>%
  mutate(prediction = if_else(pred > 0.5, 1, 0)) %>%
  ungroup() %>% 
  select(response, prediction)

me_kappa <- kappa2(me_response3)
me_kappa$value

##################################
#mw
mw_response2 <- mw_response %>%
  mutate(floor_dt = floor_date(datetime_maxstage, 'hour'))
    
mw_response2 <- left_join(mw_response2, ben_q, by = 'floor_dt') %>%
  mutate(doy = yday(floor_dt))

mw_glm <- glm(response ~ q_cms + doy, data = mw_response2, family = binomial)

mw_response2$pred <- predict(mw_glm, mw_response2, type = 'response')

mw_response3 <- mw_response2 %>%
  mutate(prediction = if_else(pred > 0.5, 1, 0)) %>%
  ungroup() %>% 
  select(response, prediction)

mw_kappa <- kappa2(mw_response3)
mw_kappa$value

#############################################
#um
um_response2 <- um_response %>%
  mutate(floor_dt = floor_date(datetime_maxstage, 'hour'))
    
um_response2 <- left_join(um_response2, ben_q, by = 'floor_dt') %>%
  mutate(doy = yday(floor_dt))

um_glm <- glm(response ~ q_cms + doy, data = um_response2, family = binomial)

um_response2$pred <- predict(um_glm, um_response2, type = 'response')

um_response3 <- um_response2 %>%
  mutate(prediction = if_else(pred > 0.5, 1, 0)) %>%
  ungroup() %>% 
  select(response, prediction)

um_kappa <- kappa2(um_response3)
um_kappa$value

#####################################################
#ue
ue_response2 <- ue_response %>%
  mutate(floor_dt = floor_date(datetime_maxstage, 'hour'))
    
ue_response2 <- left_join(ue_response2, ben_q, by = 'floor_dt') %>%
  mutate(doy = yday(floor_dt))

ue_glm <- glm(response ~ q_cms + doy, data = ue_response2, family = binomial)

ue_response2$pred <- predict(ue_glm, ue_response2, type = 'response')

ue_response3 <- ue_response2 %>%
  mutate(prediction = if_else(pred > 0.5, 1, 0)) %>%
  ungroup() %>% 
  select(response, prediction)

ue_kappa <- kappa2(ue_response3)
ue_kappa$value

###################################################
#uw
uw_response2 <- uw_response %>%
  mutate(floor_dt = floor_date(datetime_maxstage, 'hour'))
    
uw_response2 <- left_join(uw_response2, ben_q, by = 'floor_dt') %>%
  mutate(doy = yday(floor_dt))

uw_glm <- glm(response ~ q_cms + doy, data = uw_response2, family = binomial)

uw_response2$pred <- predict(uw_glm, uw_response2, type = 'response')

uw_response3 <- uw_response2 %>%
  mutate(prediction = if_else(pred > 0.5, 1, 0)) %>%
  ungroup() %>% 
  select(response, prediction)

uw_kappa <- kappa2(uw_response3)
uw_kappa$value

## make a df for this
first <- c('me', 'mm', 'mw',
           'ue', 'um', 'uw')
second <- c(me_kappa$value, mm_kappa$value, mw_kappa$value,
            ue_kappa$value, um_kappa$value, uw_kappa$value)

log_kappas <- data.frame(first,second) %>%
  rename(site = first,
         kappa = second)

kable(log_kappas) %>%
  kable_styling()

```


```{r}
#trying to add bed incision
# bedtest <- function(events_df, stage_df) {
#   
#   response <- data.frame()
#   
#   for(i in 1:nrow(events_df)){
#     temp <- stage_df %>%
#       filter(datetime >=(events_df$starttime[i]) 
#              & datetime <=(events_df$endtime[i] + 12*60*60))
#     
#     temp$event = ifelse(temp$datetime >=(events_df$starttime[i]) 
#                         & temp$datetime <=(events_df$endtime[i] + 12*60*60),
#                         events_df$event[i])
#     
#     temp$duration_hr = ifelse(temp$datetime >=(events_df$starttime[i]) 
#                               & temp$datetime <=(events_df$endtime[i] + 12*60*60),
#                               events_df$duration_hr[i])
#     
#     temp$P = ifelse(temp$datetime >=(events_df$starttime[i]) 
#                     & temp$datetime <=(events_df$endtime[i] + 12*60*60),
#                     events_df$P[i])
#     
#     temp$MI5 = ifelse(temp$datetime >=(events_df$starttime[i]) 
#                       & temp$datetime <=(events_df$endtime[i] + 12*60*60),
#                       events_df$MI5[i])
#     
#     temp$MI15 = ifelse(temp$datetime >=(events_df$starttime[i]) 
#                        & temp$datetime <=(events_df$endtime[i] + 12*60*60),
#                        events_df$MI15[i])
#     
#     temp$MI30 = ifelse(temp$datetime >=(events_df$starttime[i]) 
#                        & temp$datetime <=(events_df$endtime[i] + 12*60*60),
#                        events_df$MI30[i])
#     
#     temp$MI60 = ifelse(temp$datetime >=(events_df$starttime[i]) 
#                        & temp$datetime <=(events_df$endtime[i] + 12*60*60),
#                        events_df$MI60[i])
#     
#     temp$starttime = ifelse(temp$datetime >=(events_df$starttime[i]) 
#                             & temp$datetime <=(events_df$endtime[i] + 12*60*60),
#                             events_df$starttime[i])
#     
#     temp$endtime = ifelse(temp$datetime >=(events_df$starttime[i]) 
#                           & temp$datetime <=(events_df$endtime[i] + 12*60*60),
#                           events_df$endtime[i])
#     
#     response <- rbind(response, temp)
#   }
  
  #out <- response #%>%
    # group_by(event) %>%
    # mutate(Stage_range = max(Stage_mm) - min(Stage_mm)) %>%
    # group_by(event) %>%
    # filter(Stage_mm == max(Stage_mm)) %>%
    # rename(Stage_mm_max = Stage_mm) %>% 
    # group_by(event) %>%
    # filter(datetime == max(datetime)) %>%
    # rename(datetime_maxstage = datetime) %>%
    # mutate(starttime_rain = as_datetime(starttime),
    #        endtime_rain = as_datetime(endtime),
    #        lag2p_hr = as.numeric(datetime_maxstage - starttime_rain)) %>%
    # filter(!duration_hr == 0) %>%
    # mutate(response = ifelse(Stage_range > 2, 1, 0)) %>% 
    # select(-c(starttime, endtime))
    # 
#}

#me_response2 <- bedtest(me_events, me_stage)




```

